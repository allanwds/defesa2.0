{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gráficos de Ocorrências</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: 'Rubik', sans-serif; background:#fff3e0; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); margin-bottom: 30px; }
        h3 { color: #ff9800; margin-bottom: 20px; }
        select, input[type=date], button { padding: 8px 12px; border-radius: 8px; border:1px solid #ccc; margin-right: 10px; }
        button { background-color: #fb8c00; color: #fff; border: none; cursor: pointer; }
        button:hover { background-color: #f57c00; }
        canvas { margin-top: 20px; }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <h3>Filtros</h3>
        <select id="filtro-distrito">
            <option value="">Todos os distritos</option>
        </select>
        <select id="filtro-motivo">
            <option value="">Todos os motivos</option>
        </select>
        <input type="date" id="data-inicio">
        <input type="date" id="data-fim">
        <button id="aplicar-filtros">Aplicar</button>
    </div>

    <div class="card">
        <h3>Ocorrências por Motivo</h3>
        <canvas id="grafico-motivos" width="400" height="200"></canvas>
    </div>

    <div class="card">
        <h3>Ocorrências por Distrito</h3>
        <canvas id="grafico-distritos" width="400" height="200"></canvas>
    </div>
</div>

<script>
let chartMotivos = null;
let chartDistritos = null;

function carregarFiltros(data) {
    const selectDistrito = $('#filtro-distrito');
    const selectMotivo = $('#filtro-motivo');
    selectDistrito.empty().append('<option value="">Todos os distritos</option>');
    selectMotivo.empty().append('<option value="">Todos os motivos</option>');

    data.distritos.labels.forEach(d => selectDistrito.append(`<option value="${d}">${d}</option>`));
    data.motivos.labels.forEach(m => selectMotivo.append(`<option value="${m}">${m}</option>`));
}

function atualizarGraficos(filtros={}) {
    $.getJSON("{% url 'graficos_data' %}", filtros, function(data) {
        carregarFiltros(data);

        // Gráfico Motivos
        if (chartMotivos) chartMotivos.destroy();
        const ctxMotivos = document.getElementById('grafico-motivos').getContext('2d');
        chartMotivos = new Chart(ctxMotivos, {
            type: 'bar',
            data: {
                labels: data.motivos.labels,
                datasets: [{
                    label: 'Quantidade',
                    data: data.motivos.data,
                    backgroundColor: '#fb8c00'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // Gráfico Distritos
        if (chartDistritos) chartDistritos.destroy();
        const ctxDistritos = document.getElementById('grafico-distritos').getContext('2d');
        chartDistritos = new Chart(ctxDistritos, {
            type: 'bar',
            data: {
                labels: data.distritos.labels,
                datasets: [{
                    label: 'Quantidade',
                    data: data.distritos.data,
                    backgroundColor: '#f57c00'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    });
}

// Inicializa os gráficos ao carregar a página
$(document).ready(function() {
    atualizarGraficos();

    // Botão de filtros
    $('#aplicar-filtros').click(function() {
        const filtros = {
            distrito: $('#filtro-distrito').val(),
            motivo: $('#filtro-motivo').val(),
            data_inicio: $('#data-inicio').val(),
            data_fim: $('#data-fim').val()
        };
        atualizarGraficos(filtros);
    });
});
</script>
</body>
</html>
{% include 'accessibility_widget.html' %}

