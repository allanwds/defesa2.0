{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Ocorr√™ncia</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family:'Rubik',sans-serif; background:#fff3e0; margin:0; padding:0; color:#333; }
    header { background:#ff9800; color:#fff; text-align:center; padding:20px 0; font-size:2em; box-shadow:0 4px 6px rgba(0,0,0,.2); }
    .logo { width:120px; margin-bottom:10px; }
    .form-container { display:flex; justify-content:center; padding:40px 20px; }
    form { display:flex; flex-direction:column; gap:20px; max-width:800px; width:100%; background:#fff; padding:40px; border-radius:16px; box-shadow:0 8px 16px rgba(0,0,0,.15); position:relative; }
    .form-row { display:flex; gap:20px; flex-wrap:wrap; width:100%; }
    .form-group { display:flex; flex-direction:column; }
    .small { flex:0 0 120px; }
    .medium { flex:1; min-width:200px; }
    .large { flex:2; min-width:400px; }
    label { font-weight:600; margin-bottom:5px; text-transform:uppercase; font-size:.9em; }
    input, select { padding:10px; border-radius:10px; border:1px solid #ccc; background:#fffaf3; font-size:1em; width:100%; box-sizing:border-box; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    .top-buttons { position:absolute; top:45px; right:40px; display:flex; gap:10px; z-index:1; } /* fica atr√°s do alerta */
    .submit-btn,.back-btn { padding:10px 25px; font-size:1em; background:#fb8c00; color:#fff; border:none; border-radius:25px; cursor:pointer; transition:.3s; box-shadow:0 6px 12px rgba(0,0,0,.15); }
    .submit-btn:hover,.back-btn:hover { background:#f57c00; transform:translateY(-2px); }
    footer { text-align:center; padding:20px; background:#333; color:#fff; font-size:.9em; margin-top:40px; }
    #map { height:400px; border-radius:12px; margin-top:10px; }
    .alert { background:#ffebee; color:#b71c1c; padding:10px; border-radius:8px; margin-bottom:15px; position:relative; z-index:2; } /* aparece por cima */
    .field-error { color:#b71c1c; margin-top:4px; font-size:.9em; }
  </style>
</head>
<body>
  <header>
    <img src="https://www.prefeitura.sp.gov.br/cidade/secretarias/upload/comunicacao/noticias/defesacivil.jpg" alt="Logo Defesa Civil S√£o Paulo" class="logo">
    <h3>CADASTRO DE OCORR√äNCIA</h3>
  </header>

  <div class="form-container">
    <form method="POST" action="{% url 'salvar_ocorrencia' %}">
      {% csrf_token %}

      {# A) Messages framework #}
      {% if messages %}
        <div class="alert" role="alert" aria-live="assertive">
          {% for message in messages %}
            {{ message }}
          {% endfor %}
        </div>
      {% endif %}

      {# B) Erros gerais do form (add_error(None, ...)/clean()) #}
      {% if form.non_field_errors %}
        <div class="alert" role="alert" aria-live="assertive">
          {% for err in form.non_field_errors %}
            {{ err }}
          {% endfor %}
        </div>
      {% endif %}

      {# C) Lista de erros por campo #}
      {% if form.errors %}
        <div class="alert" role="alert" aria-live="assertive">
          <ul style="margin:0; padding-left:18px;">
            {% for bf in form %}
              {% for error in bf.errors %}
                <li><strong>{{ bf.label }}:</strong> {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <div class="form-row">
        <div class="form-group small">
          <label for="{{ form.numero.id_for_label }}">FOC N.¬∫</label>
          {{ form.numero }}
          {% for error in form.numero.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>

        <div class="form-group small">
          <label for="{{ form.sigrc.id_for_label }}">SIGRC N.¬∫</label>
          {{ form.sigrc }}
          {% for error in form.sigrc.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>

        <div class="top-buttons">
          <button type="submit" class="submit-btn">üíæ Salvar</button>
          <a href="{% url 'home' %}" style="text-decoration:none;">
            <button type="button" class="back-btn">‚¨Ö Voltar</button>
          </a>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group large">
          {{ form.endereco.label_tag }}
          {{ form.endereco }}
          {% for error in form.endereco.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group medium">
          {{ form.bairro.label_tag }}
          {{ form.bairro }}
          {% for error in form.bairro.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>

        <div class="form-group medium">
          <label for="distrito">Distrito</label>
          <select name="distrito" id="distrito" required>
            <option value="">Selecione</option>
            <option value="Jd. Angela" {% if form.distrito.value == 'Jd. Angela' %}selected{% endif %}>Jardim √Çngela</option>
            <option value="Jd. S√£o Luis" {% if form.distrito.value == 'Jd. S√£o Luis' %}selected{% endif %}>Jardim S√£o Lu√≠s</option>
          </select>
          {% for error in form.distrito.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group small">
          <label for="area_risco">√Årea de Risco</label>
          <select id="area_risco" name="area_risco" required>
            <option value="">Selecione</option>
            <option value="0" {% if form.area_risco.value|stringformat:'s' == '0' %}selected{% endif %}>0</option>
            <option value="1" {% if form.area_risco.value|stringformat:'s' == '1' %}selected{% endif %}>1</option>
            <option value="2" {% if form.area_risco.value|stringformat:'s' == '2' %}selected{% endif %}>2</option>
            <option value="3" {% if form.area_risco.value|stringformat:'s' == '3' %}selected{% endif %}>3</option>
            <option value="4" {% if form.area_risco.value|stringformat:'s' == '4' %}selected{% endif %}>4</option>
          </select>
          {% for error in form.area_risco.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>

        <div class="form-group large">
          <label for="motivo">Motivo</label>
          <select name="motivo" id="motivo" required>
            {% with val=form.motivo.value %}
              <option value="">Selecione</option>
              <option value="Eros√£o na via" {% if val == 'Eros√£o na via' %}selected{% endif %}>Eros√£o na via</option>
              <option value="Deslizamento" {% if val == 'Deslizamento' %}selected{% endif %}>Deslizamento</option>
              <option value="Desabamento" {% if val == 'Desabamento' %}selected{% endif %}>Desabamento</option>
              <option value="Rachadura em Edifica√ß√£o" {% if val == 'Rachadura em Edifica√ß√£o' %}selected{% endif %}>Rachadura em edifica√ß√£o</option>
              <option value="Risco de desabamento" {% if val == 'Risco de desabamento' %}selected{% endif %}>Risco de desabamento</option>
              <option value="Risco de queda de √°rvore" {% if val == 'Risco de queda de √°rvore' %}selected{% endif %}>Risco de queda de √°rvore</option>
              <option value="Queda de √°rvore" {% if val == 'Queda de √°rvore' %}selected{% endif %}>Queda de √°rvore</option>
              <option value="Alagamento" {% if val == 'Alagamento' %}selected{% endif %}>Alagamento</option>
              <option value="Inunda√ß√£o" {% if val == 'Inunda√ß√£o' %}selected{% endif %}>Inunda√ß√£o</option>
              <option value="Outros" {% if val == 'Outros' %}selected{% endif %}>Outros</option>
            {% endwith %}
          </select>
          {% for error in form.motivo.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>

        <div class="form-group small">
          <label for="data">Data</label>
          <input type="date" id="data" name="data" required value="{{ form.data.value|default_if_none:'' }}">
          {% for error in form.data.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group medium">
          <label for="latitude">Latitude</label>
          <input type="text" id="latitude" name="latitude" readonly required value="{{ form.latitude.value|default_if_none:'' }}">
          {% for error in form.latitude.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>
        <div class="form-group medium">
          <label for="longitude">Longitude</label>
          <input type="text" id="longitude" name="longitude" readonly required value="{{ form.longitude.value|default_if_none:'' }}">
          {% for error in form.longitude.errors %}
            <small class="field-error">{{ error }}</small>
          {% endfor %}
        </div>
      </div>

      <div id="map"></div>
    </form>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var map = L.map('map').setView([-23.66761, -46.72835], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
    var marker = L.marker([-23.66761, -46.72835], { draggable: true }).addTo(map);

    marker.on('dragend', function () {
      var latlng = marker.getLatLng();
      document.getElementById("latitude").value = latlng.lat.toFixed(7);
      document.getElementById("longitude").value = latlng.lng.toFixed(7);
    });

    map.on('click', function (e) {
      var lat = e.latlng.lat, lng = e.latlng.lng;
      marker.setLatLng([lat, lng]);
      document.getElementById("latitude").value = lat.toFixed(7);
      document.getElementById("longitude").value = lng.toFixed(7);
    });

    async function buscarEndereco() {
      var enderecoInput = document.getElementById("id_endereco");
      if (!enderecoInput) return;
      var endereco = enderecoInput.value;
      if (!endereco) return;

      try {
        var url = 'https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=' + encodeURIComponent(endereco + ', S√£o Paulo, Brasil');
        var response = await fetch(url, { headers: { 'Accept-Language': 'pt-BR' } });
        var data = await response.json();

        if (data && data.length > 0) {
          var result = data.find(function (item) {
            return item.address.city === 'S√£o Paulo' || item.address.state_district === 'S√£o Paulo';
          });
          if (result) {
            var lat = parseFloat(result.lat);
            var lon = parseFloat(result.lon);
            marker.setLatLng([lat, lon]);
            map.setView([lat, lon], 16);
            document.getElementById("latitude").value = lat.toFixed(7);
            document.getElementById("longitude").value = lon.toFixed(7);
          } else {
            alert("ATEN√á√ÉO! ENDERE√áO ENCONTRADO FORA DA CIDADE DE S√ÉO PAULO. CONFIRME SE FOI DIGITADO CORRETAMENTE OU COLOQUE MAIS INFORMA√á√ïES PARA BUSCA");
          }
        } else {
          alert("ENDERE√áO N√ÉO ENCONTRADO");
        }
      } catch (error) {
        console.error("Erro ao buscar endere√ßo:", error);
        alert("Erro ao buscar endere√ßo. Tente novamente.");
      }
    }

    (function () {
      var formEl = document.querySelector('form');
      if (!formEl) return;
      formEl.addEventListener('submit', function (e) {
        var latEl = document.getElementById('latitude');
        var lonEl = document.getElementById('longitude');
        var lat = (latEl ? latEl.value : '').trim();
        var lon = (lonEl ? lonEl.value : '').trim();
        if (latEl) latEl.setCustomValidity('');
        if (lonEl) lonEl.setCustomValidity('');
        if (!lat || !lon) {
          e.preventDefault();
          if (latEl) latEl.setCustomValidity('Obrigat√≥rio: selecione no mapa ou busque o endere√ßo.');
          if (lonEl) lonEl.setCustomValidity('Obrigat√≥rio: selecione no mapa ou busque o endere√ßo.');
          formEl.reportValidity();
        }
      });
    })();

    var enderecoField = document.getElementById("id_endereco");
    if (enderecoField) {
      enderecoField.addEventListener("blur", buscarEndereco);
    }
  </script>

  <footer>
    <p>&copy; 2025 UNIVESP - PROJETO INTEGRADOR EM COMPUTA√á√ÉO I e II - Todos os direitos reservados</p>
  </footer>
</body>
</html>
