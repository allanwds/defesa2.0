{% load extras %}
{% block content %}
<body class="bg-light">
    <header class="text-center my-4">
      <img src="https://www.prefeitura.sp.gov.br/cidade/secretarias/upload/comunicacao/noticias/defesacivil.jpg" alt="Logo Defesa Civil SÃ£o Paulo" class="logo" style="max-width: 300px;">
    </header>

<div class="container my-5">
    <!-- CabeÃ§alho -->
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">ðŸ“Š RELATÃ“RIO DDEC-MB</h1>
        <p class="text-muted">EstatÃ­sticas atualizadas das ocorrÃªncias</p>
    </div>

    <!-- Filtros e BotÃµes -->
    <div class="d-flex flex-wrap justify-content-center gap-3 mb-5">
        <select id="periodoFiltro" class="form-select w-auto shadow-sm">
            <option value="7">Ãšltimos 7 dias</option>
            <option value="30">Ãšltimos 30 dias</option>
            <option value="90">Ãšltimos 90 dias</option>
            <option value="custom">Escolher data</option>
        </select>

        <input type="date" id="dataInicio" class="form-control w-auto shadow-sm d-none">
        <input type="date" id="dataFim" class="form-control w-auto shadow-sm d-none">

        <button class="btn btn-primary shadow-sm" onclick="exportarPDF()">ðŸ“„ PDF</button>
        <button class="btn btn-success shadow-sm" onclick="exportarExcel()">ðŸ“‘ Excel</button>
    </div>

    <!-- Cards com GrÃ¡ficos -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow rounded-4 h-100">
                <div class="card-body">
                    <h5 class="card-title fw-bold">OcorrÃªncias por Tipo</h5>
                    <h6 class="card-subtitle mb-3 text-muted">Total: {{ total_motivos }}</h6>
                    <canvas id="graficoMotivos" style="height:300px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow rounded-4 h-100">
                <div class="card-body">
                    <h5 class="card-title fw-bold">OcorrÃªncias por Distrito</h5>
                    <h6 class="card-subtitle mb-3 text-muted">Total: {{ total_distritos }}</h6>
                    <canvas id="graficoDistritos" style="height:300px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const ctxMotivos = document.getElementById('graficoMotivos').getContext('2d');
new Chart(ctxMotivos, {
    type: 'bar',
    data: {
        labels: [{% for motivo in motivos_count %}"{{ motivo.motivo }}",{% endfor %}],
        datasets: [{
            label: 'Quantidade',
            data: [{% for motivo in motivos_count %}{{ motivo.total }},{% endfor %}],
            backgroundColor: 'rgba(0, 123, 255, 0.7)',
            borderRadius: 8,
            barThickness: 30
        }]
    },
    options: {
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
    }
});

const ctxDistritos = document.getElementById('graficoDistritos').getContext('2d');
new Chart(ctxDistritos, {
    type: 'bar',
    data: {
        labels: [{% for distrito in distritos_count %}"{{ distrito.distrito }}",{% endfor %}],
        datasets: [{
            label: 'Quantidade',
            data: [{% for distrito in distritos_count %}{{ distrito.total }},{% endfor %}],
            backgroundColor: 'rgba(255, 193, 7, 0.7)',
            borderRadius: 8,
            barThickness: 30
        }]
    },
    options: {
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
    }
});

function exportarExcel() {
    const wb = XLSX.utils.book_new();
    const wsMotivos = XLSX.utils.aoa_to_sheet([
        ["Motivo", "Total"],
        {% for motivo in motivos_count %} ["{{ motivo.motivo }}", {{ motivo.total }}], {% endfor %}
    ]);
    const wsDistritos = XLSX.utils.aoa_to_sheet([
        ["Distrito", "Total"],
        {% for distrito in distritos_count %} ["{{ distrito.distrito }}", {{ distrito.total }}], {% endfor %}
    ]);
    XLSX.utils.book_append_sheet(wb, wsMotivos, "Motivos");
    XLSX.utils.book_append_sheet(wb, wsDistritos, "Distritos");
    XLSX.writeFile(wb, "relatorio-ddec-mb.xlsx");
}

function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text("RelatÃ³rio DDEC-MB", 20, 20);

    doc.setFontSize(12);
    doc.text("OcorrÃªncias por Tipo:", 20, 30);
    {% for motivo in motivos_count %}
        doc.text("{{ motivo.motivo }}: {{ motivo.total }}", 20, 40 + {{ forloop.counter0 }} * 7);
    {% endfor %}

    doc.text("OcorrÃªncias por Distrito:", 20, 100);
    {% for distrito in distritos_count %}
        doc.text("{{ distrito.distrito }}: {{ distrito.total }}", 20, 110 + {{ forloop.counter0 }} * 7);
    {% endfor %}

    doc.save("relatorio-ddec-mb.pdf");
}

document.getElementById('periodoFiltro').addEventListener('change', (e) => {
    const value = e.target.value;
    const dataInicio = document.getElementById('dataInicio');
    const dataFim = document.getElementById('dataFim');
    if (value === "custom") {
        dataInicio.classList.remove('d-none');
        dataFim.classList.remove('d-none');
    } else {
        dataInicio.classList.add('d-none');
        dataFim.classList.add('d-none');
    }
});
</script>
</body>
{% endblock %}
